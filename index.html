<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Inventory Dashboard (Cognito Secured)</title>

<!-- OIDC Client (CDN) -->
<script type="module">
  import { UserManager } from "https://cdn.jsdelivr.net/npm/oidc-client-ts@3.0.1/dist/oidc-client-ts.min.js";

  /***********************
   * COGNITO CONFIG
   ***********************/
  const cognitoConfig = {
    authority: "https://cognito-idp.ap-south-1.amazonaws.com/ap-south-1_7cYokKnU8",
    client_id: "5le9dqqqrn1ai0ma4au0vc264s",
    redirect_uri: window.location.origin,
    post_logout_redirect_uri: window.location.origin,
    response_type: "code",
    scope: "openid email phone",
  };

  const userManager = new UserManager(cognitoConfig);
  window.userManager = userManager;
</script>

<style>
  * { box-sizing: border-box; font-family: Poppins, Arial, sans-serif; }
  body { background: #f4f6f8; margin: 0; padding: 20px; }
  .container { max-width: 1100px; margin: auto; }
  .header { font-size: 36px; font-weight: 800; margin-bottom: 20px; }
  .btn { background:#111827;color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer }
  .btn:hover { background:#374151 }
  .stock-panel { display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px }
  .stock-item { background:white;padding:20px;border-radius:10px;min-width:140px;text-align:center }
  .section { background:white;padding:20px;border-radius:10px;margin-bottom:20px }
  select,input { padding:10px;width:100%;margin-bottom:10px }
  #toast { position:fixed;bottom:20px;right:20px;background:#111827;color:white;padding:12px 20px;border-radius:6px;display:none }
</style>
</head>

<body>
<div class="container">

  <div class="header">Inventory Dashboard</div>

  <div>
    Logged in as: <strong id="email"></strong>
    <button class="btn" onclick="logout()">Logout</button>
  </div>

  <div class="stock-panel" id="stockPanel"></div>

  <div class="section">
    <h3>Withdraw Stock</h3>
    <select id="withdrawProduct"></select>
    <input type="number" id="withdrawAmount" placeholder="Amount" />
    <button class="btn" onclick="withdrawStock()">Withdraw</button>
  </div>

  <div class="section">
    <h3>Refill Stock</h3>
    <select id="refillProduct"></select>
    <input type="number" id="refillAmount" placeholder="Amount" />
    <button class="btn" onclick="refillStock()">Refill</button>
  </div>

  <div class="section">
    <h3>Add Product</h3>
    <input id="newProductName" placeholder="Product Name" />
    <input id="newProductStock" type="number" placeholder="Initial Stock" />
    <button class="btn" onclick="addProduct()">Add</button>
  </div>

</div>

<div id="toast"></div>

<script type="module">
  /***********************
   * AUTH HANDLING
   ***********************/
  const API_BASE = "https://cdnag593k4.execute-api.ap-south-1.amazonaws.com/prod";
  let products = [];
  let accessToken = null;

  function toast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 3000);
  }

  async function loginIfNeeded() {
    if (window.location.search.includes("code=")) {
      await userManager.signinRedirectCallback();
      window.history.replaceState({}, document.title, "/");
    }

    const user = await userManager.getUser();
    if (!user) {
      await userManager.signinRedirect();
      return;
    }

    accessToken = user.access_token;
    document.getElementById("email").innerText = user.profile.email;
    loadProducts();
  }

  window.logout = () => {
    const domain = "https://ap-south-17cyokknu8.auth.ap-south-1.amazoncognito.com";
    const url =
      `${domain}/logout?client_id=${cognitoConfig.client_id}` +
      `&logout_uri=${encodeURIComponent(window.location.origin)}`;
    window.location.href = url;
  };

  /***********************
   * AUTH FETCH
   ***********************/
  async function authFetch(url, options = {}) {
    return fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": "application/json",
      },
    });
  }

  /***********************
   * INVENTORY LOGIC
   ***********************/
  async function loadProducts() {
    const res = await authFetch(API_BASE + "/products");
    products = await res.json();

    const w = document.getElementById("withdrawProduct");
    const r = document.getElementById("refillProduct");
    w.innerHTML = r.innerHTML = "";

    products.forEach(p => {
      w.innerHTML += `<option value="${p.productId}">${p.name}</option>`;
      r.innerHTML += `<option value="${p.productId}">${p.name}</option>`;
    });

    const panel = document.getElementById("stockPanel");
    panel.innerHTML = "";
    products.forEach(p => {
      panel.innerHTML += `<div class="stock-item"><h2>${p.stock}</h2>${p.name}</div>`;
    });
  }

  window.addProduct = async () => {
    await authFetch(API_BASE + "/products", {
      method: "POST",
      body: JSON.stringify({
        name: newProductName.value,
        stock: +newProductStock.value
      })
    });
    toast("Product added");
    loadProducts();
  };

  window.withdrawStock = async () => {
    const p = products.find(x => x.productId == withdrawProduct.value);
    const amt = +withdrawAmount.value;
    if (amt > p.stock) return toast("Not enough stock");
    await authFetch(`${API_BASE}/products/${p.productId}`, {
      method: "PUT",
      body: JSON.stringify({ stock: p.stock - amt })
    });
    toast("Stock withdrawn");
    loadProducts();
  };

  window.refillStock = async () => {
    const p = products.find(x => x.productId == refillProduct.value);
    const amt = +refillAmount.value;
    await authFetch(`${API_BASE}/products/${p.productId}`, {
      method: "PUT",
      body: JSON.stringify({ stock: p.stock + amt })
    });
    toast("Stock refilled");
    loadProducts();
  };

  loginIfNeeded();
</script>
</body>
</html>
