<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory Dashboard</title>
<style>
  * { box-sizing: border-box; margin:0; padding:0; font-family: 'Poppins', 'Segoe UI', 'Roboto', sans-serif; }
  body { background: #f4f6f8; color: #1f2937; font-size: 16px; min-height: 100vh; display: flex; flex-direction: column; }
  button { cursor: pointer; transition: all 0.3s; font-family: inherit; font-weight: 500; }

  /* Auth Screens */
  #login-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    text-align: center;
  }
  
  /* Helper classes for visibility */
  .hidden { display: none !important; }

  /* Your Existing Styles */
  input, select { 
    padding: 12px; 
    border: 1px solid #d1d5db; 
    border-radius: 8px; 
    width: 100%; 
    font-family: inherit; 
    font-size: 16px; 
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  input:focus, select:focus { border-color: #4f46e5; box-shadow: 0 0 8px rgba(79,70,229,0.2); outline: none; }

  .page-header {
    font-size: 38px;
    font-weight: 800;
    margin-bottom: 30px;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .page-header span.highlight {
    font-weight: 900;
    background: linear-gradient(90deg, #f97316, #facc15);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .user-info { font-size: 14px; color: #6b7280; font-weight: normal; margin-right: 15px; }

  .container { max-width: 1100px; margin: 0 auto; padding: 20px; width: 100%; }

  .section { 
    background: #ffffff; 
    border-radius: 12px; 
    padding: 20px; 
    margin-bottom: 20px; 
    box-shadow: 0 3px 10px rgba(0,0,0,0.05); 
    transition: transform 0.3s, box-shadow 0.3s;
  }
  .section:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
  .section h2 { margin-bottom: 15px; font-size: 20px; color: #111827; font-weight: 600; }

  .stock-panel { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; border-radius: 12px; background: #e5e7eb; }
  .stock-item { 
    flex: 1; 
    min-width: 120px; 
    text-align: center; 
    background: #f3f4f6; 
    border-radius: 12px; 
    padding: 20px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
    transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
    cursor: default;
    animation: fadeInUp 0.5s ease forwards;
  }
  .stock-item:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); background: #eef2ff; }
  .stock-item h3 { font-size: 22px; font-weight: 700; margin-bottom: 5px; color: #111827; }

  @keyframes fadeInUp {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  .btn { 
    padding: 12px 24px;
    min-width: 120px;
    background: #1f2937; 
    color: white; 
    border: none; 
    border-radius: 8px; 
    font-weight: 600; 
    font-size: 16px; 
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .btn:hover { background: #374151; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
  .btn-danger { background: #dc2626; margin-left: 10px; }
  .btn-danger:hover { background: #b91c1c; }

  .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
  .input-group input, .input-group select { flex: 1; }

  #toast { 
    position: fixed; bottom: 30px; right: 30px; background: #111827; 
    color: white; padding: 15px 25px; border-radius: 8px; 
    opacity: 0; pointer-events: none; transform: translateY(20px);
    transition: all 0.4s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 200; 
  }
  #toast.show { opacity: 1; pointer-events: auto; transform: translateY(0); }
</style>
</head>
<body>

<div id="login-section">
  <div class="page-header" style="justify-content: center;">Inventory <span class="highlight">Dashboard</span></div>
  <p style="margin-bottom: 20px; color: #6b7280;">Please sign in to access the inventory.</p>
  <button id="signInBtn" class="btn">Sign In with AWS Cognito</button>
</div>

<div id="app-content" class="container hidden">
  
  <div class="page-header">
    <div>Inventory <span class="highlight">Dashboard</span></div>
    <div style="display:flex; align-items:center;">
      <span id="userEmail" class="user-info"></span>
      <button id="signOutBtn" class="btn btn-danger" style="font-size: 14px; padding: 8px 16px;">Log Out</button>
    </div>
  </div>

  <div class="stock-panel" id="stockPanel"></div>

  <div class="section">
    <h2>Withdraw Stock</h2>
    <div class="input-group">
      <select id="withdrawProduct"></select>
      <input type="number" id="withdrawAmount" placeholder="Amount to withdraw" min="1">
      <button class="btn" id="btnWithdraw">Withdraw</button>
    </div>
  </div>

  <div class="section">
    <h2>Refill Stock</h2>
    <div class="input-group">
      <select id="refillProduct"></select>
      <input type="number" id="refillAmount" placeholder="Amount to add" min="1">
      <button class="btn" id="btnRefill">Refill</button>
    </div>
  </div>

  <div class="section">
    <h2>Add New Product</h2>
    <div class="input-group">
      <input type="text" id="newProductName" placeholder="Product Name">
      <input type="number" id="newProductStock" placeholder="Initial Stock" min="0">
      <button class="btn" id="btnAdd">Add Product</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
  import { UserManager } from "https://esm.sh/oidc-client-ts";

  // --- CONFIGURATION ---
  const cognitoAuthConfig = {
      authority: "https://cognito-idp.ap-south-1.amazonaws.com/ap-south-1_sVvfDsAc5",
      client_id: "5crbg8b50ivmrvu6k4t0q94rbc",
      redirect_uri: "https://main.d3hlvj0pbnmql3.amplifyapp.com/",
      response_type: "code",
      scope: "phone openid email"
  };

  // --- SETTINGS FOR LOGOUT ---
  const logoutUri = "https://main.d3hlvj0pbnmql3.amplifyapp.com/"; 
  
  // This is the domain you had in your code - it looks correct now!
  const cognitoDomain = "https://ap-south-1svvfdsac5.auth.ap-south-1.amazoncognito.com"; 

  const userManager = new UserManager(cognitoAuthConfig);

  // --- AUTH LOGIC ---
  
  async function handleAuth() {
    // 1. Check if we are coming back from Cognito (URL contains "code")
    if (window.location.search.includes("code=")) {
        try {
            await userManager.signinCallback();
            // Clean URL to remove the ugly code parameter
            window.history.replaceState({}, document.title, window.location.pathname);
        } catch (e) {
            console.error("Callback error", e);
        }
    }

    // 2. Check if user is logged in
    const user = await userManager.getUser();

    if (user) {
        // User is logged in
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("app-content").classList.remove("hidden");
        document.getElementById("userEmail").textContent = user.profile.email || "User";
        
        // Start the inventory app
        loadProducts(); 
        setInterval(loadProducts, 1444400000); // Auto refresh
    } else {
        // User is NOT logged in
        document.getElementById("login-section").classList.remove("hidden");
        document.getElementById("app-content").classList.add("hidden");
    }
  }

  // Bind Login Button
  document.getElementById("signInBtn").addEventListener("click", () => {
      userManager.signinRedirect();
  });

  // Bind Logout Button

  // Bind Logout Button
  document.getElementById("signOutBtn").addEventListener("click", async () => {
      const clientId = cognitoAuthConfig.client_id;
      // ... 
      // DELETE THE COMPLEX LOGIC AND PASTE THIS:
      
      await userManager.removeUser(); 
      
      // HARDCODE YOUR URL HERE TO TEST:
      window.location.href = "https://ap-south-1svvfdsac5.auth.ap-south-1.amazoncognito.com/logout?client_id=5crbg8b50ivmrvu6k4t0q94rbc&logout_uri=https://main.d3hlvj0pbnmql3.amplifyapp.com/";
  });

  // --- INVENTORY LOGIC ---
  
  const API_BASE = "https://cdnag593k4.execute-api.ap-south-1.amazonaws.com/prod";
  let products = [];

  function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  async function loadProducts() {
    try {
      const res = await fetch(API_BASE + "/products");
      products = await res.json();

      const withdrawSelect = document.getElementById('withdrawProduct');
      const refillSelect = document.getElementById('refillProduct');
      
      const currentWithdraw = withdrawSelect.value;
      const currentRefill = refillSelect.value;

      withdrawSelect.innerHTML = '';
      refillSelect.innerHTML = '';
      
      products.forEach(p => {
        withdrawSelect.innerHTML += `<option value="${p.productId}">${p.name}</option>`;
        refillSelect.innerHTML += `<option value="${p.productId}">${p.name}</option>`;
      });

      if(currentWithdraw) withdrawSelect.value = currentWithdraw;
      if(currentRefill) refillSelect.value = currentRefill;

      updateStockPanel();
    } catch(e) {
      showToast("Error loading products");
      console.error(e);
    }
  }

  function updateStockPanel() {
    const panel = document.getElementById('stockPanel');
    panel.innerHTML = '';
    products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'stock-item';
      div.innerHTML = `<h3>${p.stock}</h3><div>${p.name}</div>`;
      panel.appendChild(div);
    });
  }

  document.getElementById('btnAdd').addEventListener('click', async () => {
    const name = document.getElementById('newProductName').value.trim();
    const stock = parseInt(document.getElementById('newProductStock').value);
    if(!name || isNaN(stock)) return showToast("Enter valid name and stock");
    await fetch(API_BASE + "/products", { method: "POST", headers:{ "Content-Type":"application/json"}, body: JSON.stringify({name, stock})});
    showToast("Product added");
    loadProducts();
  });

  document.getElementById('btnWithdraw').addEventListener('click', async () => {
    const productId = document.getElementById('withdrawProduct').value;
    const amount = parseInt(document.getElementById('withdrawAmount').value);
    if(isNaN(amount) || amount <= 0) return showToast("Enter valid amount");
    const product = products.find(p => p.productId == productId);
    if(amount > product.stock) return showToast("Not enough stock");
    await fetch(`${API_BASE}/products/${productId}`, { method:"PUT", headers:{ "Content-Type":"application/json"}, body: JSON.stringify({stock: product.stock - amount})});
    showToast("Stock withdrawn");
    loadProducts();
  });

  document.getElementById('btnRefill').addEventListener('click', async () => {
    const productId = document.getElementById('refillProduct').value;
    const amount = parseInt(document.getElementById('refillAmount').value);
    if(isNaN(amount) || amount <= 0) return showToast("Enter valid amount");
    const product = products.find(p => p.productId == productId);
    await fetch(`${API_BASE}/products/${productId}`, { method:"PUT", headers:{ "Content-Type":"application/json"}, body: JSON.stringify({stock: product.stock + amount})});
    showToast("Stock refilled");
    loadProducts();
  });

  // Initialize App
  handleAuth();

</script>

</body>
</html>